
OPTION, PSDUMPFREQ=0;   // 6d data written on steps (h5).
OPTION, STATDUMPFREQ=1;  // Beam Stats written on steps (stat).
OPTION, BOUNDPDESTROYFQ=10; // Delete lost particles, if any       
OPTION, AUTOPHASE= 6; 
OPTION, VERSION = 20000;

Title, string="conversion";

//----------------------------------------------------------------------------
//Global Parameters
//----------------------------------------------------------------------------

REAL n_particles=5E4;

REAL gamma=273.97316778927893;  // KE=139.489 MeV electrons

REAL beta=sqrt(1-(1/gamma^2));

REAL P0=gamma*beta*EMASS;    //inital z momentum

value , {gamma*beta, EMASS, P0};


//----------------------------------------------------------------------------
//Bookkeeping
//----------------------------------------------------------------------------

//----------------------------------------------------------------------------
// Import Lattice definitions
//----------------------------------------------------------------------------
REAL arc_length = 0.5;
REAL bend_angle = 1.5707963267948966;
REAL bend_radius = arc_length / bend_angle;
REAL chord_length = 2 * bend_radius * SIN(bend_angle / 2.);
value , {arc_length, bend_angle, chord_length};

start_drift: DRIFT, L = 0.1, ELEMEDGE=0.0;
dipole: SBEND, L = chord_length, ANGLE = bend_angle, E1 = 0.0, E2 = 0.0,
        GAP = 0.0, PSI = 0.0, ELEMEDGE = 0.1, DESIGNENERGY = 139.4890000, FMAPFN = "hard_edge_profile.txt";
mon: MONITOR, OUTFN = "opal_monitor_dipole_end.h5", ELEMEDGE = start_drift->L + dipole->L + 0.49;
beamline_1: LINE=(start_drift, dipole, mon); 

//----------------------------------------------------------------------------
// INITIAL DISTRIBUTION
//----------------------------------------------------------------------------
        
single_particle: DISTRIBUTION, TYPE = FROMFILE,
        FNAME = "bunch_opal.txt",
        EMITTED = FALSE;
 
//----------------------------------------------------------------------------
// Define Field solvers
//----------------------------------------------------------------------------

FS_SC: Fieldsolver, FSTYPE = NONE, // None or FFT
            MX = 32, MY = 32, MT = 32,
            PARFFTX = false, 
            PARFFTY = false, 
            PARFFTT = true,  //parallel in the z direction only
            BCFFTX = open, 
            BCFFTY = open, 
            BCFFTT = open,
            BBOXINCR = 1, 
            GREENSF = INTEGRATED;

//----------------------------------------------------------------------------
// Electron Beam Definition

BEAM1:  BEAM, PARTICLE = ELECTRON, pc = P0, NPART = n_particles,
        BFREQ = 1.0e6, BCURRENT = 0.0, CHARGE = -1;

//----------------------------------------------------------------------------
// Initialize Simulation
//----------------------------------------------------------------------------

TRACK, LINE =beamline_1, BEAM = BEAM1, MAXSTEPS = 10000000, 
    DT = 1e-15, ZSTOP=2.0;

RUN, METHOD = "PARALLEL-T", BEAM = BEAM1, 
    FIELDSOLVER = FS_SC, DISTRIBUTION = single_particle;
ENDTRACK;

Stop;
Quit;
